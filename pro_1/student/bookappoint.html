<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Appointment</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(120deg, #a1c4fd, #c2e9fb);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    /* Navigation bar */
    .navbar {
      width: 100%;
      max-width: 900px;
      display: flex;
      justify-content: center;
      gap: 14px;
      margin-bottom: 20px;
    }

    .navbar a {
      text-decoration: none;
      padding: 10px 18px;
      border-radius: 12px;
      background: rgba(255,255,255,0.15);
      color: #fff;
      font-weight: 600;
      transition: all 0.2s ease;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.12);
    }

    .navbar a:hover {
      transform: translateY(-2px);
      background: rgba(255,255,255,0.25);
    }

    .navbar a.active {
      background: #ffffff;
      color: #5a67d8;
      box-shadow: 0 6px 18px rgba(90,103,216,0.18);
    }

    .container {
      background: #fff;
      padding: 35px 30px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      width: 400px;
      margin-bottom: 30px;
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 25px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #555;
    }

    input,
    select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #ddd;
      border-radius: 10px;
      outline: none;
      font-size: 15px;
      transition: 0.3s;
    }

    input:focus,
    select:focus {
      border-color: #5a67d8;
      box-shadow: 0 0 6px rgba(85, 103, 216, 0.3);
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background-color: #5a67d8;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background-color: #434bb7;
    }

    .success-message {
      display: none;
      text-align: center;
      color: green;
      font-weight: 600;
      margin-top: 15px;
    }

    /* Appointments table */
    table {
      border-collapse: collapse;
      width: 90%;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    th,
    td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #5a67d8;
      color: #fff;
    }

    td {
      color: #333;
    }

    .status {
      font-weight: bold;
    }

    .status.Pending {
      color: orange;
    }

    .status.Approved {
      color: green;
    }

    .status.Rejected {
      color: red;
    }

    .appointments-section {
      text-align: center;
      width: 90%;
      max-width: 800px;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .container { width: 100%; padding: 20px; }
      .navbar { gap: 8px; }
      .navbar a { padding: 8px 12px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <!-- Navigation with 3 items -->
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <a href="searchteacher.html">Teachers</a>
    <a href="bookappoint.html" class="active">Book Appointment</a>
    <a href="#" id="logoutBtn">Logout</a>
  </nav>

  <div class="container">
    <h2>ðŸ“… Book Appointment</h2>
    <form id="appointmentForm">
      <div class="form-group">
        <label for="teacherName">Select Teacher</label>
        <select id="teacherName" required>
          <option value="">-- Select Teacher --</option>
        </select>
      </div>

      <div class="form-group">
        <label for="subject">Subject / Topic</label>
        <input type="text" id="subject" placeholder="Enter subject or topic" required />
      </div>

      <div class="form-group">
        <label for="date">Appointment Date</label>
        <input type="date" id="date" required />
      </div>

      <div class="form-group">
        <label for="time">Time Slot</label>
        <input type="time" id="time" required />
      </div>

      <button type="submit">Book Appointment</button>
      <div class="success-message" id="successMsg">
        âœ… Appointment Booked Successfully!
      </div>
    </form>
  </div>

  <div class="appointments-section">
    <h2>ðŸ“‹ My Appointments</h2>
    <table id="appointmentsTable">
      <thead>
        <tr>
          <th>Teacher Name</th>
          <th>Teacher Email</th>
          <th>Subject</th>
          <th>Date</th>
          <th>Time</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="appointmentsBody">
        <tr><td colspan="6">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDRqIY5_KSXU6FUF23pBr6AJfR9oYu3A_w",
      authDomain: "stu-teach-booking-appointment.firebaseapp.com",
      projectId: "stu-teach-booking-appointment",
      storageBucket: "stu-teach-booking-appointment.appspot.com",
      messagingSenderId: "911059619353",
      appId: "1:911059619353:web:3ec6ee920276da87b6a488",
      measurementId: "G-L0L8ET89ZD",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const teacherSelect = document.getElementById("teacherName");
    const form = document.getElementById("appointmentForm");
    const successMsg = document.getElementById("successMsg");
    const appointmentsBody = document.getElementById("appointmentsBody");
    const logoutBtn = document.getElementById("logoutBtn");

    const studentEmail = localStorage.getItem("student");

    if (!studentEmail) {
      alert("Please login first!");
      window.location.href = "s_login.html";
    }

    // Logout handler
    logoutBtn.addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("student");
      // you can also sign out from Firebase auth if used: auth.signOut();
      window.location.href = "s_login.html";
    });

    // Load Teachers into Dropdown
    async function loadTeachers() {
      const teachersSnapshot = await getDocs(collection(db, "teachers"));
      teachersSnapshot.forEach((docSnap) => {
        const teacher = docSnap.data();
        const option = document.createElement("option");
        option.value = docSnap.id;
        option.text = `${teacher.name} - ${teacher.subject}`;
        option.setAttribute("data-name", teacher.name);
        option.setAttribute("data-email", teacher.email);
        teacherSelect.appendChild(option);
      });
    }

    // Load Appointments
    async function loadAppointments() {
      appointmentsBody.innerHTML = `<tr><td colspan="6">Loading...</td></tr>`;
      const q = query(
        collection(db, "appointments"),
        where("studentEmail", "==", studentEmail)
      );
      const snapshot = await getDocs(q);
      appointmentsBody.innerHTML = "";

      if (snapshot.empty) {
        appointmentsBody.innerHTML = `<tr><td colspan="6">No appointments found.</td></tr>`;
        return;
      }

      snapshot.forEach((docSnap) => {
        const appt = docSnap.data();
        const row = `
          <tr>
            <td>${appt.teacherName}</td>
            <td>${appt.teacherEmail}</td>
            <td>${appt.subject}</td>
            <td>${appt.date}</td>
            <td>${appt.time}</td>
            <td class="status ${appt.status}">${appt.status}</td>
          </tr>
        `;
        appointmentsBody.innerHTML += row;
      });
    }

    // Add Appointment with Teacher Name & Email
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const selectedOption = teacherSelect.options[teacherSelect.selectedIndex];
      const teacherId = selectedOption.value;
      const teacherName = selectedOption.getAttribute("data-name");
      const teacherEmail = selectedOption.getAttribute("data-email");

      const appointment = {
        studentEmail,
        teacherId,
        teacherName,
        teacherEmail,
        subject: document.getElementById("subject").value,
        date: document.getElementById("date").value,
        time: document.getElementById("time").value,
        status: "Pending",
        createdAt: new Date().toISOString(),
      };

      try {
        await addDoc(collection(db, "appointments"), appointment);
        successMsg.style.display = "block";
        form.reset();
        await loadAppointments();
        setTimeout(() => (successMsg.style.display = "none"), 3000);
      } catch (err) {
        console.error("Error saving appointment:", err);
        alert("Error booking appointment. Try again!");
      }
    });

    // Run on page load
    loadTeachers();
    loadAppointments();
  </script>
</body>
</html>
